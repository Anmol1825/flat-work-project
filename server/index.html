<script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- FINAL SECURITY CHECK ---
        const token = localStorage.getItem('token');
        if (!token) {
            // If there's no token, the user is not logged in.
            // Redirect them to the login page immediately.
            window.location.href = '/login.html';
            return; // Stop running the rest of the script
        }

        // --- DECODE TOKEN TO CHECK FOR ADMIN ROLE ---
        let user = {};
        try {
            const payload = JSON.parse(atob(token.split('.')[1]));
            user = { email: payload.email, isAdmin: payload.isAdmin };
        } catch (e) {
            console.error('Failed to decode token:', e);
            localStorage.removeItem('token');
            window.location.href = '/login.html';
            return;
        }

        // --- ELEMENT SELECTIONS ---
        const adminPanel = document.getElementById('adminPanel');
        const userRoleBadge = document.getElementById('userRoleBadge');
        const taskForm = document.getElementById('taskForm');
        const taskInput = document.getElementById('taskInput');
        const assigneeInput = document.getElementById('assigneeInput');
        const taskDeadlineInput = document.getElementById('taskDeadlineInput');
        const taskList = document.getElementById('taskList');
        const assigneeList = document.getElementById('assigneeList');
        const emptyState = document.getElementById('emptyState');
        const taskStats = document.getElementById('taskStats');
        
        // --- STATE AND CONFIG ---
        let tasks = [];
        let currentFilter = 'all';
        const API_URL = '/tasks';
        
        // --- SHOW ADMIN PANEL & BADGE ---
        if (user.isAdmin) {
            adminPanel.classList.remove('hidden');
            userRoleBadge.textContent = 'ADMIN';
            userRoleBadge.className = 'ml-2 text-xs px-2 py-1 rounded-full admin-badge';
        } else {
            userRoleBadge.textContent = 'USER';
            userRoleBadge.className = 'ml-2 text-xs px-2 py-1 rounded-full user-badge';
        }

        // --- SERVER COMMUNICATION FUNCTIONS (WITH TOKEN) ---
        const authHeaders = {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}` // This is the "access pass"
        };

        async function fetchTasks() {
            try {
                const response = await fetch(API_URL, { headers: authHeaders });
                if (response.status === 401 || response.status === 403) {
                    localStorage.removeItem('token');
                    window.location.href = '/login.html';
                    return;
                }
                tasks = await response.json();
                renderAssigneeDashboard();
                renderTasks();
            } catch (error) {
                console.error("Failed to fetch tasks:", error);
            }
        }

        async function addTask(text, assignee, deadline) {
            await fetch(API_URL, {
                method: 'POST',
                headers: authHeaders,
                body: JSON.stringify({ text, assignee, deadline })
            });
            fetchTasks(); 
        }

        async function toggleTask(id) {
            await fetch(`${API_URL}/${id}`, {
                method: 'PATCH',
                headers: authHeaders
            });
            fetchTasks();
        }
        
        async function deleteTask(id) {
            await fetch(`${API_URL}/${id}`, {
                method: 'DELETE',
                headers: authHeaders
            });
            fetchTasks();
        }

        // --- UI RENDERING FUNCTIONS ---
        function renderAssigneeDashboard() {
            const assignees = [...new Set(tasks.map(task => task.assignee))];
            assigneeList.innerHTML = '';
            const allButton = document.createElement('button');
            allButton.textContent = 'All Tasks';
            allButton.className = 'assignee-btn';
            if (currentFilter === 'all') { allButton.classList.add('active'); }
            allButton.addEventListener('click', () => {
                currentFilter = 'all';
                renderTasks();
                renderAssigneeDashboard();
            });
            assigneeList.appendChild(allButton);

            assignees.forEach(assignee => {
                const button = document.createElement('button');
                button.textContent = assignee;
                button.className = 'assignee-btn';
                if (currentFilter === assignee) { button.classList.add('active'); }
                button.addEventListener('click', () => {
                    currentFilter = assignee;
                    renderTasks();
                    renderAssigneeDashboard();
                });
                assigneeList.appendChild(button);
            });
        }

        function renderTasks() {
            let filteredTasks = tasks;
            if (currentFilter !== 'all') {
                filteredTasks = tasks.filter(task => task.assignee === currentFilter);
            }

            if (filteredTasks.length === 0) {
                emptyState.style.display = 'block';
                taskList.innerHTML = '';
                updateStats(filteredTasks);
                return;
            }
            
            emptyState.style.display = 'none';
            taskList.innerHTML = '';
            const now = Date.now();
            
            filteredTasks.forEach(task => {
                const isOverdue = !task.completed && task.deadline && task.deadline < now;
                const taskElement = document.createElement('div');
                taskElement.className = `task-card px-5 py-3 flex items-center ${task.completed ? 'bg-gray-50' : ''}`;
                const statusColumn = document.createElement('div'); statusColumn.className = 'flex items-center w-16'; const checkbox = document.createElement('div'); checkbox.className = `mr-2 flex-shrink-0 flex items-center justify-center h-6 w-6 rounded-full ${task.completed ? 'status-completed' : 'status-pending'}`; if (!task.completed) { checkbox.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 cursor-pointer" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>`; checkbox.addEventListener('click', () => toggleTask(task.id)); } else { checkbox.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>`; } statusColumn.appendChild(checkbox);
                const taskColumn = document.createElement('div'); taskColumn.className = 'flex-1 min-w-0 task-description'; const text = document.createElement('p'); text.className = `text-sm font-medium ${task.completed ? 'text-gray-500 line-through' : 'text-gray-900'}`; text.textContent = task.text; if (isOverdue) text.classList.add('overdue'); taskColumn.appendChild(text);
                const assigneeColumn = document.createElement('div'); assigneeColumn.className = 'w-32'; const assignee = document.createElement('span'); assignee.className = 'assignee-pill'; assignee.textContent = task.assignee; if (isOverdue) assignee.classList.add('overdue'); assigneeColumn.appendChild(assignee);
                const dateColumn = document.createElement('div'); dateColumn.className = 'w-24 text-xs text-gray-500'; if (task.deadline) { dateColumn.textContent = new Date(task.deadline).toLocaleDateString(); } else { dateColumn.textContent = new Date(task.timestamp).toLocaleDateString(); }
                const actionsColumn = document.createElement('div'); actionsColumn.className = 'w-16 flex justify-end'; if (user.isAdmin) { const deleteButton = document.createElement('button'); deleteButton.className = 'text-sm font-medium text-red-600 hover:text-red-800'; deleteButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>`; deleteButton.addEventListener('click', () => deleteTask(task.id)); actionsColumn.appendChild(deleteButton); }
                const flexContainer = document.createElement('div'); flexContainer.className = 'flex items-center gap-4 w-full task-row'; flexContainer.append(statusColumn, taskColumn, assigneeColumn, dateColumn, actionsColumn); taskElement.appendChild(flexContainer); taskList.appendChild(taskElement);
            });
            updateStats(filteredTasks);
        }

        function updateStats(tasksToCount) {
            const totalTasks = tasksToCount.length;
            const completedTasks = tasksToCount.filter(task => task.completed).length;
            taskStats.textContent = `${completedTasks}/${totalTasks} tasks completed`;
        }

        // --- EVENT LISTENERS ---
        taskForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const text = taskInput.value.trim();
            const assignee = assigneeInput.value.trim();
            const deadlineValue = taskDeadlineInput.value;
            const deadline = deadlineValue ? new Date(deadlineValue).getTime() : null;

            if (text && assignee) {
                addTask(text, assignee, deadline);
                taskInput.value = '';
                assigneeInput.value = '';
                taskDeadlineInput.value = '';
                taskInput.focus();
            }
        });

        // Initial Load
        fetchTasks();
    });
</script>